<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Schedule API Test</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
                line-height: 1.6;
            }
            h1,
            h2 {
                color: #333;
            }
            pre {
                background-color: #f5f5f5;
                padding: 15px;
                border-radius: 5px;
                overflow-x: auto;
            }
            button {
                background-color: #4caf50;
                color: white;
                padding: 10px 15px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
                margin: 10px 0;
            }
            button:hover {
                background-color: #45a049;
            }
            .result {
                margin-top: 20px;
                border-left: 4px solid #4caf50;
                padding-left: 15px;
            }
            .error {
                color: #d32f2f;
                background-color: #ffebee;
                padding: 10px;
                border-radius: 4px;
            }
            .success {
                color: #2e7d32;
                background-color: #e8f5e9;
                padding: 10px;
                border-radius: 4px;
            }
        </style>
    </head>
    <body>
        <h1>Schedule Generation API Test</h1>
        <p>This page tests the schedule generation API endpoint to verify MongoDB ObjectID handling.</p>

        <h2>Test Data</h2>
        <pre id="testData">Loading...</pre>

        <button id="generateBtn">Generate Schedule</button>
        <button id="validateBtn">Validate Only</button>
        <button id="fetchClassesBtn">Fetch Classes</button>
        <button id="fetchCoursesBtn">Fetch Courses</button>

        <div id="result" class="result">
            <h3>Result:</h3>
            <pre id="resultOutput">No data yet. Click a button to test.</pre>
        </div>

        <script>
            // API endpoint
            const API_URL = "http://localhost:5000/api";

            // Default test data
            let testData = {
                department_id: "6802140acf7fab6f85e1d31a",
                start_date: "2025-06-01",
                end_date: "2025-12-01",
                total_weeks: 24,
                events: [],
                courses: [],
                constraints: {},
                schedule_details: [
                    {
                        class_id: "6802140acf7fab6f85e1d31c",
                        course_id: "6802140acf7fab6f85e1d323",
                        day_of_week: 1,
                        week_number: 1,
                        start_time: "07:30:00",
                        end_time: "09:00:00",
                        is_practical: false,
                        is_exam: false,
                        is_self_study: false,
                        special_event_id: null,
                        notes: "Test schedule entry",
                    },
                ],
            };

            // Display test data
            document.getElementById("testData").textContent = JSON.stringify(testData, null, 2);

            // Generate Schedule button
            document.getElementById("generateBtn").addEventListener("click", async () => {
                try {
                    const resultOutput = document.getElementById("resultOutput");
                    resultOutput.textContent = "Generating schedule...";
                    resultOutput.className = "";

                    const response = await fetch(`${API_URL}/schedule/generate`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(testData),
                    });

                    const data = await response.json();

                    if (response.ok) {
                        resultOutput.textContent = `Success!\n\n${JSON.stringify(data, null, 2)}`;
                        resultOutput.className = "success";

                        // Now check if it was saved to the database
                        await checkSavedSchedules();
                    } else {
                        resultOutput.textContent = `API Error: ${response.status}\n\n${JSON.stringify(data, null, 2)}`;
                        resultOutput.className = "error";
                    }
                } catch (error) {
                    document.getElementById("resultOutput").textContent = `Error: ${error.message}`;
                    document.getElementById("resultOutput").className = "error";
                }
            });

            // Validate button - does client-side validation only
            document.getElementById("validateBtn").addEventListener("click", () => {
                try {
                    const resultOutput = document.getElementById("resultOutput");
                    resultOutput.textContent = "Validating data...";
                    resultOutput.className = "";

                    // Simple validation
                    const isValid = validateScheduleDetails(testData.schedule_details);

                    if (isValid) {
                        resultOutput.textContent = `Validation successful. Test data looks good!`;
                        resultOutput.className = "success";
                    } else {
                        resultOutput.textContent = `Validation failed. See console for details.`;
                        resultOutput.className = "error";
                    }
                } catch (error) {
                    document.getElementById("resultOutput").textContent = `Error: ${error.message}`;
                    document.getElementById("resultOutput").className = "error";
                }
            });

            // Fetch Classes button
            document.getElementById("fetchClassesBtn").addEventListener("click", async () => {
                try {
                    const resultOutput = document.getElementById("resultOutput");
                    resultOutput.textContent = "Fetching classes...";
                    resultOutput.className = "";

                    const response = await fetch(`${API_URL}/classes`);
                    const data = await response.json();

                    if (response.ok) {
                        resultOutput.textContent = `Found ${data.length} classes\n\nSample:\n${JSON.stringify(
                            data.slice(0, 3),
                            null,
                            2
                        )}`;
                        resultOutput.className = "success";

                        // Update the test data with real class IDs if available
                        if (data.length > 0) {
                            testData.schedule_details[0].class_id = data[0]._id;
                            document.getElementById("testData").textContent = JSON.stringify(testData, null, 2);
                        }
                    } else {
                        resultOutput.textContent = `API Error: ${response.status}\n\n${JSON.stringify(data, null, 2)}`;
                        resultOutput.className = "error";
                    }
                } catch (error) {
                    document.getElementById("resultOutput").textContent = `Error: ${error.message}`;
                    document.getElementById("resultOutput").className = "error";
                }
            });

            // Fetch Courses button
            document.getElementById("fetchCoursesBtn").addEventListener("click", async () => {
                try {
                    const resultOutput = document.getElementById("resultOutput");
                    resultOutput.textContent = "Fetching courses...";
                    resultOutput.className = "";

                    const response = await fetch(`${API_URL}/courses`);
                    const data = await response.json();

                    if (response.ok) {
                        resultOutput.textContent = `Found ${data.length} courses\n\nSample:\n${JSON.stringify(
                            data.slice(0, 3),
                            null,
                            2
                        )}`;
                        resultOutput.className = "success";

                        // Update the test data with real course IDs if available
                        if (data.length > 0) {
                            testData.schedule_details[0].course_id = data[0]._id;
                            document.getElementById("testData").textContent = JSON.stringify(testData, null, 2);
                        }
                    } else {
                        resultOutput.textContent = `API Error: ${response.status}\n\n${JSON.stringify(data, null, 2)}`;
                        resultOutput.className = "error";
                    }
                } catch (error) {
                    document.getElementById("resultOutput").textContent = `Error: ${error.message}`;
                    document.getElementById("resultOutput").className = "error";
                }
            });

            // Check if schedules were saved
            async function checkSavedSchedules() {
                try {
                    const response = await fetch(`${API_URL}/schedules`);
                    const data = await response.json();

                    if (response.ok) {
                        const resultOutput = document.getElementById("resultOutput");
                        resultOutput.textContent += `\n\nFound ${data.length} schedules in the database.`;

                        if (data.length > 0) {
                            resultOutput.textContent += `\n\nMost recent schedule:\n${JSON.stringify(
                                data[0],
                                null,
                                2
                            )}`;
                        }
                    }
                } catch (error) {
                    console.error("Error checking schedules:", error);
                }
            }

            // Simple validation function
            function validateScheduleDetails(details) {
                if (!details || !Array.isArray(details) || details.length === 0) {
                    console.error("No schedule details provided");
                    return false;
                }

                let valid = true;

                details.forEach((detail, index) => {
                    // Check for required fields
                    if (!detail.class_id) {
                        console.error(`Schedule detail ${index}: Missing class_id`);
                        valid = false;
                    } else if (!isObjectIdLike(detail.class_id)) {
                        console.error(`Schedule detail ${index}: Invalid class_id format: ${detail.class_id}`);
                        valid = false;
                    }

                    if (!detail.course_id) {
                        console.error(`Schedule detail ${index}: Missing course_id`);
                        valid = false;
                    } else if (!isObjectIdLike(detail.course_id)) {
                        console.error(`Schedule detail ${index}: Invalid course_id format: ${detail.course_id}`);
                        valid = false;
                    }

                    if (!detail.day_of_week || detail.day_of_week < 1 || detail.day_of_week > 7) {
                        console.error(`Schedule detail ${index}: Invalid day_of_week: ${detail.day_of_week}`);
                        valid = false;
                    }

                    if (!detail.week_number || detail.week_number < 1) {
                        console.error(`Schedule detail ${index}: Invalid week_number: ${detail.week_number}`);
                        valid = false;
                    }

                    if (!detail.start_time) {
                        console.error(`Schedule detail ${index}: Missing start_time`);
                        valid = false;
                    }

                    if (!detail.end_time) {
                        console.error(`Schedule detail ${index}: Missing end_time`);
                        valid = false;
                    }
                });

                return valid;
            }

            // Check if string looks like MongoDB ObjectID
            function isObjectIdLike(str) {
                if (!str || typeof str !== "string") return false;
                return /^[0-9a-fA-F]{24}$/.test(str);
            }
        </script>
    </body>
</html>
